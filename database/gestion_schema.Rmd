---
title: "Gestion des schémas de la base Postgre"
output: html_document
date: "2024-06-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
```

```{r package message=FALSE, warning=FALSE}
library(dplyr)
library(DBI)
source(file = "connexion_db.R")
conn <- connecter()
num_departement <- '60'
temps_apres <- 24
temps_avant <- 23
```

```{r voir les schémas contenant les tables nécessaires}
dbGetQuery(conn, paste0(" 
  SELECT DISTINCT
      schemaname,
      tablename
  FROM 
      pg_indexes 
  WHERE 
      tablename LIKE 'parc_%'
  ORDER BY 
      schemaname, tablename;
           "))
```

```{r voir les schémas de traitement}
dbGetQuery(conn, paste0(" 
  SELECT 
      schema_name
  FROM 
      information_schema.schemata
  WHERE 
      schema_name LIKE 'traitement_%';
           "))
```
```{r voir les tables de traitement fixe}
dbGetQuery(conn, paste0(" 
  SELECT 
      schemaname,
      tablename
  FROM 
      pg_tables
  WHERE 
      schemaname = '", paste0("traitement_", temps_apres, "_", temps_avant, "_cadastre_" , num_departement), "'
  ORDER BY 
      schemaname, tablename;
           "))
```

```{r supprimer un schéma de traitement}
dbExecute(conn, paste0(
  "DROP SCHEMA IF EXISTS traitement_", temps_apres, "_", temps_avant, "_cadastre_", num_departement, " CASCADE;"))
```

```{r supprimer tous les schémas de traitement}
schemas_to_drop <- dbGetQuery(conn, "
  SELECT schema_name
  FROM information_schema.schemata
  WHERE schema_name LIKE 'traitement_%';
")

# Générer les commandes DROP SCHEMA
drop_commands <- paste0("DROP SCHEMA IF EXISTS \"", schemas_to_drop$schema_name, "\" CASCADE;")

# Exécuter les commandes DROP SCHEMA
lapply(drop_commands, function(cmd) {
  dbExecute(conn, cmd)
})
```


