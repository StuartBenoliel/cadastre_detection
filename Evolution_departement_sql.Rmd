---
title: "Evolution departement parcelles"
output: html_document
date: "2024-06-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
```

# Import package + fonction utilisés après

```{r package message=FALSE, warning=FALSE}
library(sf)
library(dplyr)
library(mapview)
library(DBI)
library(ggplot2)
library(webshot)
library(stringr)
# webshot::install_phantomjs()
source(file = "database/connexion_db.R")
conn <- connecter()
DBI::dbListTables(conn)
source(file = "database/fonction_sql.R")

indic_bordure <- F
num_departement <- 13
temps_apres <- 24
temps_avant <- 23
```

```{r remise à zero des tables de traitements}
dbExecute(conn, "DROP SCHEMA IF EXISTS cadastre_temp CASCADE")

source(file = "database/traitement_db.R")
dbExecute(conn, "SET client_min_messages TO NOTICE;")
```

```{r voir les index}
dbGetQuery(conn, " SELECT 
    schemaname,
    tablename, 
    indexname, 
    indexdef 
FROM 
    pg_indexes 
WHERE 
    schemaname = 'cadastre_temp' 
    OR schemaname = 'public';
           ")
```

```{r voir les tables de cadastre_temp}
dbGetQuery(conn, " SELECT 
    schemaname,
    tablename
FROM 
    pg_tables
WHERE 
    schemaname = 'cadastre_temp'
ORDER BY 
    schemaname, tablename;
           ")
```

# Importation des parcelles sur l'ensemble du département et des périodes données

```{r ajout/supp_tot sql}
dbExecute(conn, "TRUNCATE TABLE ajout_tot, supp_tot;")

dbExecute(conn, paste0("
  INSERT INTO ajout_tot
  SELECT idu, nom_com, code_com, com_abs, contenance, geometry 
  FROM parc_", num_departement, "_", temps_apres, " parc_apres
  WHERE NOT EXISTS (
    SELECT 1
    FROM parc_", num_departement, "_", temps_avant," parc_avant
    WHERE parc_apres.idu = parc_avant.idu
  );
"))

dbExecute(conn, paste0("
  INSERT INTO supp_tot
  SELECT idu, nom_com, code_com, com_abs, contenance, geometry 
  FROM parc_", num_departement, "_", temps_avant, " parc_avant
  WHERE NOT EXISTS (
    SELECT 1
    FROM parc_", num_departement, "_", temps_apres," parc_apres
    WHERE parc_avant.idu = parc_apres.idu
  );
"))
```

```{r import commune}
commune <- st_read(conn, query = paste0("SELECT code_insee, nom_com, geometry FROM com_", num_departement, ";"))
ajout_tot <- st_read(conn, query = "SELECT * FROM ajout_tot;")
supp_tot <- st_read(conn, query = "SELECT * FROM supp_tot;")
```

# Définition de la bordure dans laquelle je considère que mes parcelles doivent apartenir entièrement

```{r creation bordure et avec ou sans}
dbExecute(conn, "TRUNCATE TABLE bordure, ins_parc_apres, ins_parc_avant, ajout, supp;")

dbExecute(conn, paste0("
  INSERT INTO bordure
  SELECT
      code_insee, nom_com,
      ST_Multi(
          ST_Simplify(
              ST_Difference(
                  ST_Buffer(geometry, 250), ST_Buffer(geometry, -250)
              )
          , 10)
      ) AS geometry
  FROM
      com_", num_departement, ";"
))

dbExecute(conn, paste0("
  INSERT INTO ins_parc_avant
  SELECT DISTINCT
      pa.idu, pa.nom_com, pa.code_com, pa.com_abs, pa.contenance, pa.geometry 
  FROM
      parc_", num_departement, "_", temps_avant, " pa", 
  ifelse(indic_bordure, "
  JOIN
      bordure
  ON
      ST_WITHIN(pa.geometry, bordure.geometry);", ";")))

dbExecute(conn, paste0("
  INSERT INTO ins_parc_apres
  SELECT DISTINCT
      pa.idu, pa.nom_com, pa.code_com, pa.com_abs, pa.contenance, pa.geometry 
  FROM
      parc_", num_departement, "_", temps_apres, " pa", 
  ifelse(indic_bordure, "
  JOIN
      bordure
  ON
      ST_WITHIN(pa.geometry, bordure.geometry);", ";")))

dbExecute(conn, paste0("
  INSERT INTO ajout
  SELECT DISTINCT
      at.idu, at.nom_com, at.code_com, at.com_abs, at.contenance, at.geometry 
  FROM
      ajout_tot at", 
  ifelse(indic_bordure, "
  JOIN
      bordure
  ON
      ST_WITHIN(at.geometry, bordure.geometry);", ";")))

dbExecute(conn, paste0("
  INSERT INTO supp
  SELECT DISTINCT
      st.idu, st.nom_com, st.code_com, st.com_abs, st.contenance, st.geometry 
  FROM
      supp_tot st", 
  ifelse(indic_bordure, "
  JOIN
      bordure
  ON
      ST_WITHIN(st.geometry, bordure.geometry);", ";")))
```


```{r bordure sql}
bordure <- st_read(conn, query = "SELECT * FROM bordure;") %>%
  mutate(geometry = st_cast(geometry, "MULTIPOLYGON"))

ins_parc_avant <- st_read(conn, query = "SELECT * FROM ins_parc_avant;")
ins_parc_apres <- st_read(conn, query = "SELECT * FROM ins_parc_apres;")
```

# Focus sur les parcelles dont je peux comparer l'état sur les deux périodes facilement (cad parcelles ayant conservé leur identifiant)

## Elimination des parcelles IDENTIQUES en tout point du polygone (méthode de base pour enlever les cas reconnaissables facilement)

```{r modif geometry egal sql}
dbExecute(conn, "TRUNCATE TABLE identique, modif_apres, modif_avant, modif;")

dbExecute(conn, "
  INSERT INTO identique
  SELECT apres.idu
  FROM ins_parc_apres apres
  WHERE EXISTS (
      SELECT 1
      FROM ins_parc_avant avant
      WHERE apres.idu = avant.idu
      AND ST_Equals(
          ST_SnapToGrid(apres.geometry, 0.0001), 
          ST_SnapToGrid(avant.geometry, 0.0001)
      )
  );
")

dbExecute(conn, "
  INSERT INTO modif_avant
  SELECT avant.*
  FROM ins_parc_avant avant
  WHERE NOT EXISTS (
      SELECT 1
      FROM identique
      WHERE avant.idu = identique.idu
  )
  AND NOT EXISTS (
      SELECT 1
      FROM supp
      WHERE avant.idu = supp.idu
  );
")

dbExecute(conn, "
  INSERT INTO modif_apres
  SELECT apres.*
  FROM ins_parc_apres apres
  WHERE NOT EXISTS (
      SELECT 1
      FROM identique
      WHERE apres.idu = identique.idu
  )
  AND NOT EXISTS (
      SELECT 1
      FROM ajout
      WHERE apres.idu = ajout.idu
  );
")

dbExecute(conn, "
  INSERT INTO modif
  SELECT
      COALESCE(avant.idu, apres.idu) AS idu,
      avant.geometry AS geometry_avant,
      apres.geometry AS geometry_apres,
      calcul_iou(apres.geometry, avant.geometry) AS iou,
      calcul_iou_ajust(apres.geometry, avant.geometry) AS iou_ajust
  FROM
      modif_avant avant
  FULL JOIN
      modif_apres apres ON avant.idu = apres.idu;
")
```

```{r drop iou null sql}
# Elimine les parcelles "sans changement manifeste" plus les parcelles sans iou = parcelles n'étant plus entièrement dans la bordure lors d'un changement d'une année sur l'autre
dbExecute(conn, "
  DELETE FROM modif
  WHERE iou > 0.99 OR iou IS NULL;
")
```


```{r quantile}
# 85130000AH0055 et 85130000AH0017 supplémentaire dans sql
# modif <- st_read(conn, query = "SELECT * FROM modif;")
```

## Reconnaissances des cas de translation, modification de contour et les deux à la fois

```{r translation, contour_apres, contour_translation}
dbExecute(conn, "TRUNCATE TABLE modif_apres_iou, modif_avant_iou, 
          translation, contour, contour_translation;")

dbExecute(conn, "
  INSERT INTO modif_avant_iou
  SELECT avant.idu, avant.nom_com, avant.code_com, avant.com_abs, 
      avant.contenance, modif.iou, modif.iou_ajust, avant.geometry
  FROM modif
  LEFT JOIN modif_avant avant ON modif.idu = avant.idu;
")

dbExecute(conn, "
  INSERT INTO modif_apres_iou
  SELECT apres.idu, apres.nom_com, apres.code_com, apres.com_abs, 
      apres.contenance, modif.iou, modif.iou_ajust, apres.geometry
  FROM modif
  LEFT JOIN modif_apres apres ON modif.idu = apres.idu;
")

dbExecute(conn, "
  INSERT INTO translation
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_ajust, 
      idu AS idu_translate, geometry
  FROM modif_apres_iou
  WHERE iou_ajust > 0.99;
")

dbExecute(conn, "
  INSERT INTO contour
  SELECT idu, nom_com, code_com, com_abs, contenance,
         iou AS iou_multi,
         idu AS participants_avant,
         idu AS participants_apres,
         geometry
  FROM modif_avant_iou
  WHERE iou > 0.95 AND iou_ajust < 0.99;
")

dbExecute(conn, "
  INSERT INTO contour_translation
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_ajust, 
      idu AS idu_translate, geometry
  FROM modif_apres_iou
  WHERE iou < 0.95 AND iou_ajust > 0.95 AND iou_ajust < 0.99;
")

dbExecute(conn, "
  DELETE FROM modif_avant_iou
  WHERE idu IN (SELECT idu FROM translation)
    OR idu IN (SELECT idu FROM contour)
    OR idu IN (SELECT idu FROM contour_translation);
")

dbExecute(conn, "
  DELETE FROM modif_apres_iou
  WHERE idu IN (SELECT idu FROM translation)
    OR idu IN (SELECT idu FROM contour)
    OR idu IN (SELECT idu FROM contour_translation);
")
```

```{r modif iou_ajust -> translation}
translation_sql <- st_read(conn, query = "SELECT * FROM translation;")
contour_sql <- st_read(conn, query = "SELECT * FROM contour;")
contour_translation_sql <- st_read(conn, query = "SELECT * FROM contour_translation;")

modif_avant_sql <- st_read(conn, query = "SELECT * FROM modif_avant_iou;")
```

## Cas plus compliqués de détection des mêmes cas

```{r meme cas sql}
dbExecute(conn, "TRUNCATE TABLE modif_avant_iou_multi, multi_calcul_cache;")

dbExecute(conn, "
  INSERT INTO modif_avant_iou_multi
  SELECT idu, nom_com, code_com, com_abs, contenance, iou, iou_ajust,
    (calcul_iou_multi(idu, geometry, 'modif_avant_iou', 'modif_apres_iou')).*,
    geometry
  FROM modif_avant_iou;
")

dbExecute(conn, "
  INSERT INTO contour
  SELECT idu, nom_com, code_com, com_abs, contenance,
         iou_multi, participants_avant, participants_apres, geometry
  FROM modif_avant_iou_multi
  WHERE (iou_multi > 0.95 AND LENGTH(participants_avant) = LENGTH(participants_apres))
     OR (LENGTH(participants_avant) = 14 AND LENGTH(participants_apres) = 14 AND iou > iou_ajust);
")

dbExecute(conn, "
  INSERT INTO contour_translation
  SELECT avant.idu, avant.nom_com, avant.code_com, avant.com_abs, 
      avant.contenance, avant.iou_ajust, avant.idu, apres.geometry
  FROM modif_avant_iou_multi AS avant
  LEFT JOIN modif_apres apres ON avant.idu = apres.idu
  WHERE ((LENGTH(participants_avant) = 14 AND LENGTH(participants_apres) = 14 AND iou < iou_ajust))
     OR iou_multi IS NULL;
")

dbExecute(conn, "
  DELETE FROM modif_avant_iou_multi
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_apres, ',\\s*')) FROM contour)
    OR idu IN (SELECT idu FROM contour_translation);
")

dbExecute(conn, "
  DELETE FROM modif_apres_iou
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) FROM contour)
    OR idu IN (SELECT idu FROM contour_translation);
")
```

```{r modif iou_multi -> translation, modification de contour et les deux à la fois bis}
contour_sql <- st_read(conn, query = "SELECT * FROM contour;")
contour_translation_sql <- st_read(conn, query = "SELECT * FROM contour_translation;")
modif_avant_sql <- st_read(conn, query = "SELECT * FROM modif_avant_iou_multi;")
```

```{r enveloppe convexe}
# NE PAS RELANCER
dbExecute(conn, "TRUNCATE TABLE modif_avant_iou_convex;")

dbExecute(conn, "
  INSERT INTO modif_avant_iou_convex
  SELECT idu, nom_com, code_com, com_abs, contenance, iou, iou_ajust, iou_multi,
      calcul_iou_convex('modif_avant_iou_multi', 'modif_apres_iou', participants_avant, participants_apres) AS iou_convex,
      participants_avant, participants_apres, geometry
  FROM modif_avant_iou_multi;
")

dbExecute(conn, "
  INSERT INTO contour
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_convex AS iou_multi, 
      participants_avant, participants_apres, geometry
  FROM modif_avant_iou_convex
  WHERE iou_convex > 0.99 AND LENGTH(participants_avant) = LENGTH(participants_apres);
")

dbExecute(conn, "
  DELETE FROM modif_avant_iou_convex
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_apres, ',\\s*')) FROM contour);
")

dbExecute(conn, "
  DELETE FROM modif_apres_iou
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) FROM contour);
")
```

```{r convex}
contour_sql <- st_read(conn, query = "SELECT * FROM contour;")

modif_avant_sql <- st_read(conn, query = "SELECT * FROM modif_avant_iou_convex;")
modif_apres_sql <- st_read(conn, query = "SELECT * FROM modif_apres_iou;")
```

```{r présomption}
# NE PAS RELANCER
dbExecute(conn, "
  INSERT INTO contour
  SELECT idu, nom_com, code_com, com_abs, contenance,
         iou_multi, participants_avant, participants_apres, geometry
  FROM modif_avant_iou_convex
  WHERE iou_ajust < (iou + 0.1);
")

dbExecute(conn, "
  INSERT INTO contour_translation
  SELECT avant.idu, avant.nom_com, avant.code_com, avant.com_abs, 
         avant.contenance, avant.iou_ajust,
         avant.idu AS idu_translate, apres.geometry
  FROM modif_avant_iou_convex AS avant
  LEFT JOIN modif_apres apres ON avant.idu = apres.idu
  WHERE iou_ajust > (iou + 0.1);
")

dbExecute(conn, "
  DELETE FROM modif_avant_iou_convex
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_apres, ',\\s*')) FROM contour)
    OR idu IN (SELECT idu FROM contour_translation);
")

dbExecute(conn, "
  DELETE FROM modif_apres_iou
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) FROM contour)
    OR idu IN (SELECT idu FROM contour_translation);
")
```

```{r presomption sql}
contour_sql <- st_read(conn, query = "SELECT * FROM contour;")
contour_translation_sql <- st_read(conn, query = "SELECT * FROM contour_translation;")

modif_avant_sql <- st_read(conn, query = "SELECT * FROM modif_avant_iou_convex;")
modif_apres_sql <- st_read(conn, query = "SELECT * FROM modif_apres_iou;")
```


```{r mapview typologie parcelles modifiées, eval=FALSE, include=FALSE}
map <- mapview(bordure, layer.name = "Bordures étendues", col.regions = "lightgrey", 
               alpha.regions = 0.5, homebutton = F,
               map.types = c("CartoDB.Positron", "OpenStreetMap", "Esri.WorldImagery"))

if (nrow(translation_sql) > 0) {
  map <- map + mapview(translation_sql,
                       layer.name = paste0("Parcelles translatées (état 20",temps_apres,")"), 
                       col.regions = "darkcyan",
                       alpha.regions = 0.5, homebutton = F) +
    mapview(ins_parc_avant %>%
              filter(idu %in% translation_sql$idu_translate),
            col.regions = "darkcyan",
            layer.name = paste0("Parcelles translatées (état 20",temps_avant,")"), 
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(contour_sql) > 0) {
  map <- map + mapview(ins_parc_apres %>%
                         filter(idu %in% contour_sql$idu),  
                       layer.name = paste0("Parcelles contours (état 20",temps_apres,")"), 
                       col.regions = "orange", alpha.regions = 0.5, homebutton = F)  +
    mapview(contour_sql,  
            layer.name = paste0("Parcelles contours (état 20",temps_avant,")"),
            col.regions = "orange",
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(contour_translation_sql) > 0) {
  map <- map + mapview(contour_translation_sql,  
                       layer.name = paste0("Parcelles translatées + contours (état 20",temps_apres,")"), 
                       alpha.regions = 0.5, homebutton = F) +
    mapview(ins_parc_avant %>%
              filter(idu %in% contour_translation_sql$idu_translate),
            layer.name = paste0("Parcelles translatées + contours (état 20",temps_avant,")"), 
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(modif_apres_sql) > 0) {
  map <- map + mapview(modif_apres_sql, 
                       z = c("iou_ajust"), 
                       layer.name = paste0("Parcelles modifiées restantes (état 20",temps_apres,")"), 
                       alpha.regions = 0.5, homebutton = F)
  
}
if (nrow(modif_avant_sql) > 0) {
  map <- map + mapview(modif_avant_sql, 
                       z = c("iou_ajust"), 
                       layer.name = paste0("Parcelles modifiées restantes (état 20",temps_avant,")"), 
                       alpha.regions = 0.5, homebutton = F)
}

mapshot(map, url = paste0("parcelles_modifiés_",num_departement,"_",temps_apres,"-",temps_avant,".html"))
```

# Focus des parcelles ayant changé de communes

## Cas des parcelles dans le cas d'une fusion de communes

```{r ajout/supp -> focus fusion commune}
dbExecute(conn, "TRUNCATE TABLE parc_com_abs;")

dbExecute(conn, "
  INSERT INTO parc_com_abs
  SELECT idu, nom_com, code_com, com_abs, contenance,
         SUBSTR(idu, 1, 2) || com_abs || '000' || SUBSTR(idu, 9, 14) AS idu_avant,
         geometry
  FROM ajout
  WHERE com_abs != '000';
")

dbExecute(conn, "
  DELETE FROM parc_com_abs
  WHERE idu_avant NOT IN 
      (SELECT idu FROM supp
        WHERE idu IN (SELECT idu_avant FROM parc_com_abs));
")

# Parcelles n'ayant pas été modifiées mise à part le nom de commune
```

```{r parcelle changeant de communes}
parc_com_abs_sql <- st_read(conn, query = "SELECT * FROM parc_com_abs;")
```

# Focus parcelles avec changement "majeur" lié à un changement impactant l'identifiant des parcelles

## Elimination des parcelles IDENTIQUES en tout point du polygone (méthode de base pour enlever les cas reconnaissables facilement)

```{r ajout/supp geometry egal}
dbExecute(conn, "TRUNCATE TABLE ajout_simp, supp_simp;")

dbExecute(conn, "
  INSERT INTO ajout_simp
  SELECT idu, ST_SnapToGrid(geometry, 0.0001) AS geometry
  FROM ajout;
")

dbExecute(conn, "
  INSERT INTO supp_simp
  SELECT idu, ST_SnapToGrid(geometry, 0.0001) AS geometry
  FROM supp;
")

# Parcelles ajoutées n'ayant pas été modifiées
dbExecute(conn, "
  DELETE FROM ajout
  WHERE idu IN 
      (SELECT ajout_simp.idu FROM ajout_simp
        JOIN supp_simp ON ST_Equals(ajout_simp.geometry, supp_simp.geometry));
")

# Parcelles supprimées n'ayant pas été modifiées
dbExecute(conn, "
  DELETE FROM supp
  WHERE idu IN 
      (SELECT supp_simp.idu FROM supp_simp
        JOIN ajout_simp ON ST_Equals(supp_simp.geometry, ajout_simp.geometry));
")

```

## Reconnaissances des cas de fusion (peu fréquent) ou subdivision (plus courant)

```{r ajout/supp iou -> fusion/subdivision}
dbExecute(conn, "TRUNCATE TABLE ajout_iou, supp_iou, fusion, subdiv;")

dbExecute(conn, "
  INSERT INTO supp_iou
  SELECT
      idu, nom_com, code_com, com_abs, contenance,
      (calcul_iou_intersec(geometry, 'ajout')).*,
      geometry
  FROM
      supp;
")

dbExecute(conn, "
  INSERT INTO subdiv
  SELECT *
  FROM supp_iou
  WHERE iou > 0.99 AND LENGTH(participants) != 14;
")

dbExecute(conn, "
  DELETE FROM ajout
  WHERE idu IN 
      (SELECT unnest(regexp_split_to_array(participants, ',\\s*')) 
        FROM supp_iou WHERE iou > 0.99);
")

dbExecute(conn, "
  DELETE FROM supp_iou
  WHERE iou > 0.99;
")

dbExecute(conn, "
  INSERT INTO ajout_iou
  SELECT
      idu, nom_com, code_com, com_abs, contenance,
      (calcul_iou_intersec(geometry, 'supp_iou')).*,
      geometry
  FROM
      ajout;
")

dbExecute(conn, "
  INSERT INTO fusion
  SELECT *
  FROM ajout_iou
  WHERE iou > 0.99 AND LENGTH(participants) != 14;
")

dbExecute(conn, "
  DELETE FROM supp_iou
  WHERE idu IN 
      (SELECT unnest(regexp_split_to_array(participants, ',\\s*')) 
        FROM ajout_iou WHERE iou > 0.99);
")

dbExecute(conn, "
  DELETE FROM ajout_iou
  WHERE iou > 0.99;
")
```

```{r fusion/subdivision}
subdiv_sql <- st_read(conn, query = "SELECT * FROM subdiv;")
fusion_sql <- st_read(conn, query = "SELECT * FROM fusion;")
```

## (Cas particulier du remaniement du PC d'une commune) Reconnaissances des cas de translation, modification de contour avec translation

```{r ajout/supp iou_ajust -> translation, contour + translation}
dbExecute(conn, "TRUNCATE TABLE ajout_iou_translate;")

dbExecute(conn, "
  INSERT INTO ajout_iou_translate
  SELECT DISTINCT
      idu, nom_com, code_com, com_abs, contenance, iou, participants,
      (calcul_iou_intersec_best_translate(geometry, 'supp_iou')).*,
      geometry
  FROM
      ajout_iou;
")

dbExecute(conn, "
  INSERT INTO translation
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_ajust, 
      idu_translate, geometry
  FROM ajout_iou_translate
  WHERE iou_ajust > 0.99;
")

dbExecute(conn, "
  INSERT INTO contour_translation
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_ajust, 
      idu_translate, geometry
  FROM ajout_iou_translate
  WHERE (iou_ajust > 0.95 AND iou_ajust < 0.99);
")

dbExecute(conn, "
  DELETE FROM ajout_iou_translate
  WHERE idu IN (SELECT idu FROM translation)
    OR idu IN (SELECT idu FROM contour_translation);
")

dbExecute(conn, "
  DELETE FROM supp_iou
  WHERE idu IN (SELECT idu_translate FROM translation)
    OR idu IN (SELECT idu_translate FROM contour_translation);
")
```

```{r contour translation ou translation seule}
contour_translation_sql <- st_read(conn, query = "SELECT * FROM contour_translation;")
translation_sql <- st_read(conn, query = "SELECT * FROM translation;")
```

## Reconnaissances des cas de multi-subdivision (ex : 2 -> 3) ou modification de contours

```{r ajout/supp iou_multi -> multi-subdivision et contours}
dbExecute(conn, "TRUNCATE TABLE multi_calcul_cache, supp_iou_multi, 
          multi_subdiv, contour_transfo;")

dbExecute(conn, "
  INSERT INTO supp_iou_multi
  SELECT
      idu, nom_com, code_com, com_abs, contenance, iou, participants, 
      (calcul_iou_multi(idu, geometry, 'supp_iou', 'ajout_iou_translate')).*,
      geometry
  FROM
      supp_iou;
")

dbExecute(conn, "
  INSERT INTO multi_subdiv
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_multi, 
      participants_avant, participants_apres, geometry
  FROM supp_iou_multi
  WHERE iou_multi > 0.99 AND LENGTH(participants_apres) != LENGTH(participants_avant);
")

dbExecute(conn, "
  INSERT INTO contour
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_multi, 
      participants_avant, participants_apres, geometry
  FROM supp_iou_multi
  WHERE (iou_multi > 0.95 AND LENGTH(participants_apres) = LENGTH(participants_avant))
    OR (LENGTH(participants_apres) = 14 AND LENGTH(participants_avant) = 14);
")

dbExecute(conn, "
  INSERT INTO contour_transfo
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_multi, 
      participants_avant, participants_apres, geometry
  FROM supp_iou_multi
  WHERE (iou_multi > 0.95 AND LENGTH(participants_apres) != LENGTH(participants_avant)
   AND iou_multi < 0.99);
")

dbExecute(conn, "
  DELETE FROM ajout_iou_translate
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_apres, ',\\s*')) FROM multi_subdiv)
    OR idu IN (SELECT unnest(regexp_split_to_array(participants_apres, ',\\s*')) FROM contour)
    OR idu IN (SELECT unnest(regexp_split_to_array(participants_apres, ',\\s*')) FROM contour_transfo);
")

dbExecute(conn, "
  DELETE FROM supp_iou_multi
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) FROM multi_subdiv)
    OR idu IN (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) FROM contour)
    OR idu IN (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) FROM contour_transfo);
")
```

```{r multisubdiv sql}
multi_subdiv_sql <- st_read(conn, query = "SELECT * FROM multi_subdiv;")
contour_transfo_sql <- st_read(conn, query = "SELECT * FROM contour_transfo;")
contour_sql <- st_read(conn, query = "SELECT * FROM contour;")
```

## Reconnaissances des cas de modification de contours plus compliquée

## Cas rapide translation transformation

```{r rapide}
dbExecute(conn, "TRUNCATE TABLE supp_iou_multi_translate_rapide, max_iou, 
          multi_translate_rapide, contour_transfo_translation;")

dbExecute(conn, "
  INSERT INTO supp_iou_multi_translate_rapide
  SELECT 
      idu, nom_com, code_com, com_abs, contenance, iou, participants,
      iou_multi, participants_avant, participants_apres,
      (calcul_iou_multi_translate_rapide(geometry, 'supp_iou_multi', 'ajout_iou_translate')).*,
      geometry
  FROM
      supp_iou_multi;
")

dbExecute(conn, "
  INSERT INTO max_iou
  SELECT idu, MAX(iou_multi_translate) AS max_iou
  FROM (
      SELECT unnest(regexp_split_to_array(participants_avant_translate, ',\\s*')) AS idu, iou_multi_translate
      FROM supp_iou_multi_translate_rapide
      WHERE iou_multi_translate > 0.95
  ) subquery
  GROUP BY idu;
")

dbExecute(conn, "
  INSERT INTO multi_translate_rapide
  SELECT DISTINCT ON (sub.idu) sub.idu, sub.iou_multi_translate, 
      sub.participants_avant_translate, sub.participants_apres_translate
  FROM (
      SELECT unnest(regexp_split_to_array(participants_avant_translate, ',\\s*')) AS idu, 
          iou_multi_translate, participants_avant_translate, participants_apres_translate
      FROM supp_iou_multi_translate_rapide
      WHERE iou_multi_translate > 0.95
  ) sub
  JOIN max_iou mi
  ON sub.idu = mi.idu AND sub.iou_multi_translate = mi.max_iou
  ORDER BY sub.idu, sub.iou_multi_translate DESC;
")

dbExecute(conn, "
  INSERT INTO contour_transfo_translation
  SELECT simtr.idu, simtr.nom_com, simtr.code_com, simtr.com_abs, 
      simtr.contenance, mtr.iou_multi_translate, 
      mtr.participants_avant_translate, mtr.participants_apres_translate, 
      simtr.geometry
  FROM multi_translate_rapide mtr
  LEFT JOIN supp_iou_multi_translate_rapide simtr ON mtr.idu = simtr.idu;
")

dbExecute(conn, "
  DELETE FROM ajout_iou_translate
  WHERE idu IN 
      (SELECT unnest(regexp_split_to_array(participants_apres_translate, ',\\s*')) 
        FROM multi_translate_rapide);
")

dbExecute(conn, "
  DELETE FROM supp_iou_multi_translate_rapide
  WHERE idu IN 
      (SELECT unnest(regexp_split_to_array(participants_avant_translate, ',\\s*')) 
        FROM multi_translate_rapide);
")
```

```{r contour_transfo_translation_rapide}
contour_transfo_translation_sql <- st_read(conn, query = "SELECT * FROM contour_transfo_translation;")
```

## (Cas particulier du remaniement du PC d'une commune) Reconnaissances des cas de translation avec modification de contour et avec fusion

```{r ajout/supp iou_ajust -> contour_fusion_translation}
dbExecute(conn, "TRUNCATE TABLE multi_calcul_cache, supp_iou_multi_translate;")

dbExecute(conn, "
  INSERT INTO supp_iou_multi_translate
  SELECT 
      idu, nom_com, code_com, com_abs, contenance, iou, participants,
      iou_multi, participants_avant, participants_apres,
      (calcul_iou_multi_translate(idu, geometry, 'supp_iou_multi_translate_rapide', 'ajout_iou_translate')).*,
      geometry
  FROM
      supp_iou_multi_translate_rapide;
")

#Probleme maintenant
dbExecute(conn, "
  INSERT INTO contour_transfo_translation
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_multi_translate, 
      participants_avant_translate, participants_apres_translate, geometry
  FROM supp_iou_multi_translate
  WHERE iou_multi_translate > 0.95;
")

dbExecute(conn, "
  DELETE FROM ajout_iou_translate
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_apres_translate, ',\\s*')) FROM contour_transfo_translation);
")

dbExecute(conn, "
  DELETE FROM supp_iou_multi_translate
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_avant_translate, ',\\s*')) FROM contour_transfo_translation);
")
```

```{r contour_fusion_translation}
contour_transfo_translation_sql <- st_read(conn, query = "SELECT * FROM contour_transfo_translation;")
```

## Recalcul de l'IoU pour détecter les parcelles maintenant isolées -> Véritable ajout ou suppression

```{r le reste}
dbExecute(conn, "TRUNCATE TABLE supp_iou_restant, ajout_iou_restant, 
          vrai_ajout, vrai_supp;")

dbExecute(conn, "
  INSERT INTO supp_iou_restant
  SELECT
      idu, nom_com, code_com, com_abs, contenance,
      (calcul_iou_intersec(geometry, 'ajout_iou_translate')).*,
      iou_multi, participants_avant, participants_apres, 
      iou_multi_translate, participants_avant_translate, participants_apres_translate,
      geometry
  FROM
      supp_iou_multi_translate;
")

dbExecute(conn, "
  INSERT INTO ajout_iou_restant
  SELECT
      idu, nom_com, code_com, com_abs, contenance,
      (calcul_iou_intersec(geometry, 'supp_iou_multi_translate')).*, 
      iou_ajust, idu_translate, geometry
  FROM
      ajout_iou_translate;
")

dbExecute(conn, "
  INSERT INTO vrai_ajout
  SELECT idu, nom_com, code_com, com_abs, contenance, iou, participants, geometry
  FROM ajout_iou_restant
  WHERE iou IS NULL;
")

dbExecute(conn, "
  INSERT INTO vrai_supp
  SELECT idu, nom_com, code_com, com_abs, contenance, iou, participants, geometry
  FROM supp_iou_restant
  WHERE iou IS NULL;
")

dbExecute(conn, "
  DELETE FROM ajout_iou_restant
  WHERE idu IN (SELECT idu FROM vrai_ajout);
")

dbExecute(conn, "
  DELETE FROM supp_iou_restant
  WHERE idu IN (SELECT idu FROM vrai_supp);
")
```

```{r le reste}
ajout_sql <- st_read(conn, query = "SELECT * FROM ajout_iou_restant;")
supp_sql <- st_read(conn, query = "SELECT * FROM supp_iou_restant;")

vrai_ajout_sql <- st_read(conn, query = "SELECT * FROM vrai_ajout;")
vrai_supp_sql <- st_read(conn, query = "SELECT * FROM vrai_supp;")

# 132078330A0082 cas d'une parcelle disparu en 2024 mais pas affiché comme vrai supp
# 13041000AM0018 parcelle participant a une multi subdiv mais qui a l'air iou parfait
```

# Visualisation finale sur une carte du département

```{r mapview typologie parcelles, eval=FALSE, include=FALSE}
map <- mapview(bordure, 
               layer.name = "Bordures étendues", col.regions = "lightgrey", 
               alpha.regions = 0.5, homebutton = F,
               map.types = c("CartoDB.Positron", "OpenStreetMap", "Esri.WorldImagery"))

if (nrow(translation_sql) > 0) {
  map <- map + mapview(translation_sql,
                       layer.name = paste0("Parcelles translatées (état 20",temps_apres,")"), 
                       col.regions = "darkcyan",
                       alpha.regions = 0.5, homebutton = F) +
    mapview(ins_parc_avant %>%
              filter(idu %in% translation_sql$idu_translate),
            col.regions = "darkcyan",
            layer.name = paste0("Parcelles translatées (état 20",temps_avant,")"), 
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(fusion_sql) > 0) {
  map <- map + mapview(fusion_sql, 
                       layer.name = paste0("Parcelles fusionnéees (état 20",temps_apres,")"),
                       col.regions = "darkmagenta", alpha.regions = 0.5, homebutton = F) +
    mapview(supp_tot %>%
              filter(idu %in% unlist(str_split(fusion_sql$participants, ",\\s*"))),  
            layer.name = paste0("Parcelles fusionnéees (état 20",temps_avant,")"), 
            col.regions = "darkmagenta",
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(subdiv_sql) > 0) {
  map <- map + mapview(ajout_tot %>%
                         filter(idu %in% unlist(str_split(subdiv_sql$participants, ",\\s*"))),  
                       layer.name = paste0("Parcelles subdivisées (état 20",temps_apres,")"), 
                       col.regions = "purple",
                       alpha.regions = 0.5, homebutton = F) +
    mapview(subdiv_sql,  
            layer.name = paste0("Parcelles subdivisées (état 20",temps_avant,")"), 
            col.regions = "purple", alpha.regions = 0.5, homebutton = F)
}
if (nrow(multi_subdiv_sql) > 0) {
  map <- map + mapview(ajout_tot %>%
                         filter(idu %in% unlist(str_split(multi_subdiv_sql$participants_apres, ",\\s*"))),
                       layer.name = paste0("Parcelles multi-subdivision (état 20",temps_apres,")"),
                       col.regions = "magenta",
                       alpha.regions = 0.5, homebutton = F) +
    mapview(multi_subdiv_sql,  
            layer.name = paste0("Parcelles multi-subdivision (état 20",temps_avant,")"), 
            col.regions = "magenta", alpha.regions = 0.5, homebutton = F)
  
}
if (nrow(contour_sql) > 0) {
  map <- map + mapview(ins_parc_apres %>%
                         filter(idu %in% unlist(str_split(contour_sql$participants_apres, ",\\s*"))),  
                       layer.name = paste0("Parcelles contours (état 20",temps_apres,")"), 
                       col.regions = "orange", alpha.regions = 0.5, homebutton = F)  +
    mapview(contour_sql,  
            layer.name = paste0("Parcelles contours (état 20",temps_avant,")"),
            col.regions = "orange",
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(contour_transfo_sql) > 0) {
  map <- map + mapview(ajout_tot %>%
                         filter(idu %in% unlist(str_split(contour_transfo_sql$participants_apres, ",\\s*"))),  
                       layer.name = paste0("Parcelles transfo + contours (état 20",temps_apres,")"),
                       col.regions = "pink",
                       alpha.regions = 0.5, homebutton = F) +
    mapview(contour_transfo_sql,
            layer.name = paste0("Parcelles transfo + contours (état 20",temps_avant,")"), 
            col.regions = "pink", alpha.regions = 0.5, homebutton = F)
}
if (nrow(contour_translation_sql) > 0) {
  map <- map + mapview(contour_translation_sql,  
                       layer.name = paste0("Parcelles translatées + contours (état 20",temps_apres,")"), 
                       alpha.regions = 0.5, homebutton = F) +
    mapview(ins_parc_avant %>%
              filter(idu %in% contour_translation_sql$idu_translate),
            layer.name = paste0("Parcelles translatées + contours (état 20",temps_avant,")"), 
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(contour_transfo_translation_sql) > 0) {
  map <- map + mapview(ajout_tot %>%
                         filter(idu %in% unlist(str_split(contour_transfo_translation_sql$participants_apres_translate, ",\\s*"))),
                       layer.name = paste0("Parcelles transfo + translatées + contours (état 20",temps_apres,")"), 
                       col.regions = "lightblue", alpha.regions = 0.5, homebutton = F) +
    mapview(contour_transfo_translation_sql,  
            layer.name = paste0("Parcelles transfo + translatées + contours (état 20",temps_avant,")"), 
            col.regions = "lightblue",
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(parc_com_abs_sql) > 0) {
  map <- map + mapview(parc_com_abs_sql,  
                       layer.name = paste0("Parcelles fusion de communes (état 20",temps_apres,")"), 
                       col.regions = "lightgreen",
                       alpha.regions = 0.5, homebutton = F) +
    mapview(supp_tot %>%
              filter(idu %in% parc_com_abs_sql$idu_avant),  
            layer.name = paste0("Parcelles fusion de communes (état 20",temps_avant,")"), 
            col.regions = "lightgreen", alpha.regions = 0.5, homebutton = F)
}
if (nrow(vrai_ajout_sql) > 0) {
  map <- map + mapview(vrai_ajout_sql, 
                       layer.name = "Parcelles véritablement ajoutées", 
                       col.regions = "green", alpha.regions = 0.5, homebutton = F)
  
}
if (nrow(vrai_supp_sql) > 0) {
  map <- map + mapview(vrai_supp_sql,
                       layer.name = "Parcelles véritablement supprimées",
                       col.regions = "red", alpha.regions = 0.5, homebutton = F) 
}
if (nrow(ajout_sql) > 0) {
  map <- map + mapview(ajout_sql,
                       z = c("iou_ajust"), layer.name = paste0("Parcelles restantes (état 20",temps_apres,")"), 
                       alpha.regions = 0.5, homebutton = F)
}
if (nrow(supp_sql) > 0) {
  map <- map + mapview(supp_sql, 
                       z = c("iou_multi"), layer.name = paste0("Parcelles restantes (état 20",temps_avant,")"), 
                       alpha.regions = 0.5, homebutton = F)
}
if (nrow(modif_apres_sql) > 0) {
  map <- map + mapview(modif_apres_sql, 
                       z = c("iou_ajust"), 
                       layer.name = paste0("Parcelles modifiées restantes (état 20",temps_apres,")"), 
                       alpha.regions = 0.5, homebutton = F)
  
}
if (nrow(modif_avant_sql) > 0) {
  map <- map + mapview(modif_avant_sql, 
                       z = c("iou_ajust"), 
                       layer.name = paste0("Parcelles modifiées restantes (état 20",temps_avant,")"), 
                       alpha.regions = 0.5, homebutton = F)
}
mapshot(map, url = paste0("parcelles_",num_departement,"_",temps_apres,"-",temps_avant,".html"))
```