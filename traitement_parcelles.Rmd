---
title: "Traitement des parcelles d'un département"
output: html_document
date: "2024-06-18"
params:
  num_departement: "13"
  temps_apres: 24
  temps_avant: 23
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
```

# Import package + fonction utilisés après

```{r package message=FALSE, warning=FALSE}
# rm(list = ls())
library(sf)
library(dplyr)
library(mapview)
library(DBI)
library(ggplot2)
library(webshot)
library(stringr)
# webshot::install_phantomjs()
source(file = "database/connexion_db.R")
conn <- connecter()
nb_parcelles_seuil <- 5e05
source(file = "fonctions/fonction_sql.R")
```

```{r remise à zero des tables de traitements}
dbExecute(conn, paste0(
  "DROP SCHEMA IF EXISTS traitement_", params$temps_apres, "_", params$temps_avant, "_cadastre_", params$num_departement, " CASCADE;"))
source(file = "database/table_traitement_db.R")
dbExecute(conn, "SET client_min_messages TO NOTICE;")
```

# Importation des parcelles sur l'ensemble du département et des périodes données

```{r ajout/supp_tot sql}
dbExecute(conn, "TRUNCATE TABLE ajout, supp;")

dbExecute(conn, paste0("
  INSERT INTO ajout
  SELECT idu, nom_com, code_com, com_abs, contenance, geometry
  FROM parc_", params$num_departement, "_", params$temps_apres, " apres
  WHERE NOT EXISTS (
    SELECT 1
    FROM parc_", params$num_departement, "_", params$temps_avant," avant
    WHERE apres.idu = avant.idu
  );
"))

dbExecute(conn, paste0("
  INSERT INTO supp
  SELECT idu, nom_com, code_com, com_abs, contenance, geometry
  FROM parc_", params$num_departement, "_", params$temps_avant, " avant
  WHERE NOT EXISTS (
    SELECT 1
    FROM parc_", params$num_departement, "_", params$temps_apres," apres
    WHERE avant.idu = apres.idu
  );
"))
```

```{r import commune, eval=FALSE}
commune <- st_read(conn, query = paste0("SELECT * FROM com_", params$num_departement, ";"))

ajout <- st_read(conn, query = "SELECT * FROM ajout;")
supp <- st_read(conn, query = "SELECT * FROM supp;")

avant <- st_read(conn, query = paste0("SELECT * FROM parc_", params$num_departement, "_", params$temps_avant, " ORDER BY IDU LIMIT 100;"))
apres <- st_read(conn, query = paste0("SELECT * FROM parc_", params$num_departement, "_", params$temps_apres, ";"))
```

# Définition de la bordure dans laquelle je considère que mes parcelles doivent apartenir entièrement

```{r creation bordure}
dbExecute(conn, "TRUNCATE TABLE bordure;")

dbExecute(conn, paste0("
  INSERT INTO bordure
  SELECT
      code_insee, nom_com,
      ST_Multi(
          ST_Simplify(
              ST_Difference(
                  ST_Buffer(geometry, 250), ST_Buffer(geometry, -250)
              )
          , 10)
      ) AS geometry
  FROM
      com_", params$num_departement, ";"
))
```


```{r bordure sql, eval=FALSE}
bordure <- st_read(conn, query = "SELECT * FROM bordure;") %>%
  mutate(geometry = st_cast(geometry, "MULTIPOLYGON"))
```

# Focus sur les parcelles dont je peux comparer l'état sur les deux périodes facilement (cad parcelles ayant conservé leur identifiant)

## Elimination des parcelles IDENTIQUES en tout point du polygone (méthode de base pour enlever les cas reconnaissables facilement)

```{r modif geometry egal sql}
dbExecute(conn, "TRUNCATE TABLE identique, modif_apres, modif_avant, modif, cas_disparition_commune;")

dbExecute(conn, paste0("
  INSERT INTO identique
  SELECT apres.idu, apres.nom_com, avant.nom_com, apres.code_com
  FROM parc_", params$num_departement, "_", params$temps_apres, " apres
  FULL JOIN parc_", params$num_departement, "_", params$temps_avant, " avant 
    ON avant.idu = apres.idu
  WHERE EXISTS (
      SELECT 1
      FROM parc_", params$num_departement, "_", params$temps_avant, " avant
      WHERE apres.idu = avant.idu 
      AND safe_st_equals(
          ST_SnapToGrid(apres.geometry, 0.0001), 
          ST_SnapToGrid(avant.geometry, 0.0001)
      )
  );"))

dbExecute(conn, paste0(" 
  INSERT INTO cas_disparition_commune
  SELECT DISTINCT
      nom_com_apres,
      code_com,
      nom_com_avant,
      code_com
  FROM identique 
  WHERE nom_com_apres != nom_com_avant;"))

nb_parcelles <- dbGetQuery(conn, paste0("
    SELECT 
      (SELECT COUNT(*) FROM parc_", params$num_departement, "_", params$temps_apres, ") - 
      (SELECT COUNT(*) FROM identique) AS parcelles_non_identique
  "))


if (nb_parcelles$parcelles_non_identique > nb_parcelles_seuil) {
  stop(paste0("Le nombre de parcelles a traité est trop volumineux : ", nb_parcelles$parcelles_non_identique, " (contre un seuil de ", nb_parcelles_seuil, ")
       Augmenté le seuil correspondant au nombre de parcelles maximum possibles à traiter !"))
}

dbExecute(conn, paste0("
  INSERT INTO modif_avant
  SELECT avant.idu, avant.nom_com, avant.code_com, avant.com_abs, 
      avant.contenance, avant.geometry
  FROM parc_", params$num_departement, "_", params$temps_avant, " avant
  WHERE NOT EXISTS (
      SELECT 1
      FROM identique
      WHERE avant.idu = identique.idu
  ) AND NOT EXISTS (
      SELECT 1
      FROM supp
      WHERE avant.idu = supp.idu
  );"))

dbExecute(conn, paste0("
  INSERT INTO modif_apres
  SELECT apres.idu, apres.nom_com, apres.code_com, apres.com_abs, 
      apres.contenance, apres.geometry
  FROM parc_", params$num_departement, "_", params$temps_apres, " apres
  WHERE NOT EXISTS (
      SELECT 1
      FROM identique
      WHERE apres.idu = identique.idu
  ) AND NOT EXISTS (
      SELECT 1
      FROM ajout
      WHERE apres.idu = ajout.idu
  );"))

dbExecute(conn, "
  INSERT INTO modif
  SELECT
      COALESCE(avant.idu, apres.idu) AS idu,
      avant.geometry AS geometry_avant,
      apres.geometry AS geometry_apres,
      calcul_iou(apres.geometry, avant.geometry) AS iou
  FROM
      modif_avant avant
  FULL JOIN
      modif_apres apres ON avant.idu = apres.idu;
")
```


```{r drop iou null sql}
dbExecute(conn, "TRUNCATE TABLE modif_iou_ajust;")
# Elimine les parcelles "sans changement manifeste" plus les parcelles sans iou = parcelles n'ayant pas de geométrie  lors d'une année sur l'autre
dbExecute(conn, "
  DELETE FROM modif
  WHERE iou >= 0.99 OR iou IS NULL;
")

dbExecute(conn, "
  INSERT INTO modif_iou_ajust
  SELECT
      idu, iou,
      calcul_iou_ajust(geometry_apres, geometry_avant) AS iou_ajust
  FROM
      modif;
")
```

```{r modif, eval=FALSE}
modif <- st_read(conn, query = "SELECT * FROM modif_iou_ajust;")
```

## Reconnaissances des cas de translation, modification de contour et les deux à la fois

```{r translation, contour_apres, contour_translation}
dbExecute(conn, "TRUNCATE TABLE modif_apres_iou, modif_avant_iou, 
          translation, contour, contour_translation;")

dbExecute(conn, "
  INSERT INTO modif_avant_iou
  SELECT avant.idu, avant.nom_com, avant.code_com, avant.com_abs, 
      avant.contenance, ajust.iou, ajust.iou_ajust, avant.geometry
  FROM modif_iou_ajust ajust
  LEFT JOIN modif_avant avant ON ajust.idu = avant.idu;
")

dbExecute(conn, "
  INSERT INTO modif_apres_iou
  SELECT apres.idu, apres.nom_com, apres.code_com, apres.com_abs, 
      apres.contenance, ajust.iou, ajust.iou_ajust, apres.geometry
  FROM modif_iou_ajust ajust
  LEFT JOIN modif_apres apres ON ajust.idu = apres.idu;
")

dbExecute(conn, "
  INSERT INTO translation
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_ajust, 
      idu AS idu_translate, geometry
  FROM modif_apres_iou
  WHERE iou_ajust >= 0.99;
")

dbExecute(conn, "
  INSERT INTO contour
  SELECT idu, nom_com, code_com, com_abs, contenance,
         iou AS iou_multi,
         idu AS participants_avant,
         idu AS participants_apres,
         geometry
  FROM modif_avant_iou
  WHERE iou >= 0.95 AND iou_ajust < 0.99;
")

dbExecute(conn, "
  INSERT INTO contour_translation
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_ajust, 
      idu AS idu_translate, geometry
  FROM modif_apres_iou
  WHERE iou < 0.95 AND iou_ajust >= 0.95 AND iou_ajust < 0.99;
")

dbExecute(conn, "
  DELETE FROM modif_avant_iou
  WHERE EXISTS (
      SELECT 1
      FROM translation
      WHERE modif_avant_iou.idu = translation.idu
  ) OR EXISTS (
      SELECT 1
      FROM contour
      WHERE modif_avant_iou.idu = contour.idu
  ) OR EXISTS (
      SELECT 1
      FROM contour_translation
      WHERE modif_avant_iou.idu = contour_translation.idu
  );
")

dbExecute(conn, "
  DELETE FROM modif_apres_iou
  WHERE EXISTS (
      SELECT 1
      FROM translation
      WHERE modif_apres_iou.idu = translation.idu
  ) OR EXISTS (
      SELECT 1
      FROM contour
      WHERE modif_apres_iou.idu = contour.idu
  ) OR EXISTS (
      SELECT 1
      FROM contour_translation
      WHERE modif_apres_iou.idu = contour_translation.idu
  );
")
```

```{r modif iou_ajust -> translation, eval=FALSE}
translation <- st_read(conn, query = "SELECT * FROM translation;")
contour <- st_read(conn, query = "SELECT * FROM contour;")
contour_translation <- st_read(conn, query = "SELECT * FROM contour_translation;")

modif_avant <- st_read(conn, query = "SELECT * FROM modif_avant_iou;")
```

## Cas plus compliqués de détection des mêmes cas

```{r meme cas sql}
dbExecute(conn, "TRUNCATE TABLE modif_avant_iou_multi, multi_calcul_cache;")
# A NE PAS UTILISER SI NB DE PARCELLES DEPASSANT LE SEUIL
dbExecute(conn, "
  INSERT INTO modif_avant_iou_multi
  SELECT idu, nom_com, code_com, com_abs, contenance, iou, iou_ajust,
    (calcul_iou_multi(idu, geometry, 'modif_avant_iou', 'modif_apres_iou')).*,
    geometry
  FROM modif_avant_iou;
")

dbExecute(conn, "
  INSERT INTO contour
  SELECT idu, nom_com, code_com, com_abs, contenance,
         iou_multi, participants_avant, participants_apres, geometry
  FROM modif_avant_iou_multi
  WHERE (iou_multi >= 0.95 AND LENGTH(participants_avant) = LENGTH(participants_apres))
     OR (LENGTH(participants_avant) = 14 AND LENGTH(participants_apres) = 14 AND iou > iou_ajust);
")

dbExecute(conn, "
  INSERT INTO contour_translation
  SELECT avant.idu, avant.nom_com, avant.code_com, avant.com_abs, 
      avant.contenance, avant.iou_ajust, avant.idu, apres.geometry
  FROM modif_avant_iou_multi AS avant
  LEFT JOIN modif_apres apres ON avant.idu = apres.idu
  WHERE iou_multi IS NULL;
")

dbExecute(conn, "
  DELETE FROM modif_avant_iou_multi
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) FROM contour)
    OR idu IN (SELECT idu FROM contour_translation);
")

dbExecute(conn, "
  DELETE FROM modif_apres_iou
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_apres, ',\\s*')) FROM contour)
    OR idu IN (SELECT idu FROM contour_translation);
")
```

```{r modif iou_multi -> translation, modification de contour et les deux à la fois bis, eval=FALSE}
contour <- st_read(conn, query = "SELECT * FROM contour;")
contour_translation <- st_read(conn, query = "SELECT * FROM contour_translation;")
modif_avant <- st_read(conn, query = "SELECT * FROM modif_avant_iou_multi;")
```

```{r présomption}
# NE PAS RELANCER
dbExecute(conn, "
  INSERT INTO contour
  SELECT idu, nom_com, code_com, com_abs, contenance,
         iou_multi, participants_avant, participants_apres, geometry
  FROM modif_avant_iou_multi
  WHERE idu IN 
    (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) 
      FROM modif_avant_iou_multi WHERE iou_ajust < (iou + 0.1) AND LENGTH(participants_avant) = LENGTH(participants_apres));
")

dbExecute(conn, "
  INSERT INTO contour_translation
  SELECT avant.idu, avant.nom_com, avant.code_com, avant.com_abs, 
         avant.contenance, avant.iou_ajust,
         avant.idu AS idu_translate, apres.geometry
  FROM modif_avant_iou_multi AS avant
  LEFT JOIN modif_apres apres ON avant.idu = apres.idu
  WHERE iou_ajust >= (iou + 0.1) AND avant.idu NOT IN (SELECT idu FROM contour);
")

dbExecute(conn, "
  DELETE FROM modif_avant_iou_multi
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) FROM contour)
    OR idu IN (SELECT idu FROM contour_translation);
")

dbExecute(conn, "
  DELETE FROM modif_apres_iou
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) FROM contour)
    OR idu IN (SELECT idu FROM contour_translation);
")
```

```{r presomption sql, eval=FALSE}
contour <- st_read(conn, query = "SELECT * FROM contour;")
contour_translation <- st_read(conn, query = "SELECT * FROM contour_translation;")

modif_avant <- st_read(conn, query = "SELECT * FROM modif_avant_iou_multi;")
modif_apres <- st_read(conn, query = "SELECT * FROM modif_apres_iou;")
```


```{r mapview typologie parcelles modifiées, eval=FALSE}
bordure <- st_read(conn, query = "SELECT * FROM bordure;")
parc_avant <- st_read(conn, query = paste0(
  "SELECT * FROM parc_", params$num_departement, "_", params$temps_avant, ";"))

parc_apres <- st_read(conn, query = paste0(
  "SELECT * FROM parc_", params$num_departement, "_", params$temps_apres, ";"))

contour <- st_read(conn, query = "SELECT * FROM contour;")
translation <- st_read(conn, query = "SELECT * FROM translation;")
contour_translation <- st_read(conn, query = "SELECT * FROM contour_translation;")

modif_avant <- st_read(conn, query = "SELECT * FROM modif_avant_iou_multi;")
modif_apres <- st_read(conn, query = "SELECT * FROM modif_apres_iou;")

map <- mapview(bordure, layer.name = "Bordures étendues", col.regions = "#F2F2F2", 
               alpha.regions = 0.5, homebutton = F,
               map.types = c("CartoDB.Positron", "OpenStreetMap", "Esri.WorldImagery"))

if (nrow(translation) > 0) {
  map <- map + mapview(translation,
                       layer.name = paste0("Parcelles translatées (état 20",params$temps_apres,")"), 
                       col.regions = "#069F9C",
                       alpha.regions = 0.5, homebutton = F) +
    mapview(parc_avant %>%
              filter(idu %in% translation$idu_translate),
            col.regions = "#069F9C",
            layer.name = paste0("Parcelles translatées (état 20",params$temps_avant,")"), 
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(contour) > 0) {
  map <- map + mapview(parc_apres %>%
                         filter(idu %in% contour$idu),  
                       layer.name = paste0("Parcelles contours (état 20",params$temps_apres,")"), 
                       col.regions = "#D79700", alpha.regions = 0.5, homebutton = F)  +
    mapview(contour,  
            layer.name = paste0("Parcelles contours (état 20",params$temps_avant,")"),
            col.regions = "#D79700",
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(contour_translation) > 0) {
  map <- map + mapview(contour_translation,  
                       layer.name = paste0("Parcelles translatées + contours (état 20",params$temps_apres,")"), 
                       alpha.regions = 0.5, homebutton = F) +
    mapview(parc_avant %>%
              filter(idu %in% contour_translation$idu_translate),
            layer.name = paste0("Parcelles translatées + contours (état 20",params$temps_avant,")"), 
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(modif_apres) > 0) {
  map <- map + mapview(modif_apres, 
                       z = c("iou_ajust"), 
                       layer.name = paste0("Parcelles modifiées restantes (état 20",params$temps_apres,")"), 
                       alpha.regions = 0.5, homebutton = F)
  
}
if (nrow(modif_avant) > 0) {
  map <- map + mapview(modif_avant, 
                       z = c("iou_ajust"), 
                       layer.name = paste0("Parcelles modifiées restantes (état 20",params$temps_avant,")"), 
                       alpha.regions = 0.5, homebutton = F)
}

mapshot(map, url = paste0("parcelles_modifiés_",params$num_departement,"_",params$temps_apres,"-",params$temps_avant,".html"))
```

# Focus des parcelles ayant changé de communes

## Cas des parcelles dans le cas d'une défusion de communes

```{r ajout/supp -> focus défusion commune}
dbExecute(conn, "TRUNCATE TABLE defusion_com, chgt_commune;")

dbExecute(conn, "
  INSERT INTO defusion_com
  WITH avant AS (
      SELECT
          idu, nom_com, code_com,
          SUBSTR(idu, 1, 2) || com_abs || '000' || SUBSTR(idu, 9, 14) AS idu_apres
      FROM
          supp
      WHERE com_abs != '000'
  )
  SELECT 
      ajout.idu, ajout.nom_com, ajout.code_com, ajout.com_abs, ajout.contenance,
         avant.idu, avant.nom_com, avant.code_com, ajout.geometry
  FROM
      ajout
  JOIN avant ON ajout.idu = avant.idu_apres;
")

dbExecute(conn, paste0("
  INSERT INTO cas_disparition_commune
  SELECT defusion_com.nom_com, defusion_com.code_com, 
        defusion_com.nom_com_avant, defusion_com.code_com_avant  
        FROM defusion_com
  UNION DISTINCT
  SELECT 
      fusion_ajout.nom_com, fusion_ajout.code_com, 
      fusion_ajout.nom_com_avant, fusion_ajout.code_com_avant
  FROM (
      WITH avant AS (
          SELECT
              idu, nom_com, code_com,
              SUBSTR(idu, 1, 2) AS prefix_idu,
              SUBSTR(idu, 6, 14) AS suffix_idu
          FROM
              supp
          WHERE com_abs != '000'
      )
      SELECT 
          ajout.nom_com, ajout.code_com, 
          avant.nom_com AS nom_com_avant, avant.code_com AS code_com_avant
      FROM
          avant
      JOIN 
          ajout ON ajout.idu LIKE avant.prefix_idu || '___' || avant.suffix_idu
      WHERE avant.nom_com NOT IN (SELECT DISTINCT nom_com FROM parc_", params$num_departement, "_", params$temps_apres, ")
  ) AS fusion_ajout
  ;
"))

dbExecute(conn, paste0("
  INSERT INTO defusion_com
  WITH avant AS (
      SELECT
          idu, nom_com, code_com,
          SUBSTR(idu, 1, 2) AS prefix_idu,
          SUBSTR(idu, 6, 14) AS suffix_idu
      FROM
          supp
      WHERE com_abs != '000'
  )
  SELECT 
      ajout.idu, ajout.nom_com, ajout.code_com, ajout.com_abs, ajout.contenance,
         avant.idu, avant.nom_com, avant.code_com, ajout.geometry
  FROM
      avant
  JOIN ajout ON ajout.idu LIKE avant.prefix_idu || '___' || avant.suffix_idu
  WHERE avant.nom_com IN (SELECT DISTINCT nom_com FROM parc_", params$num_departement, "_", params$temps_apres,") OR
  avant.nom_com IN (SELECT nom_com_avant FROM cas_disparition_commune GROUP BY nom_com_avant HAVING COUNT(nom_com) > 1);"))

dbExecute(conn, paste0(" 
  INSERT INTO chgt_commune
  WITH defusion_data AS (
      SELECT
          nom_com_avant, 
          code_com_avant, 
          STRING_AGG(DISTINCT nom_com, ', ') AS participants,
          STRING_AGG(DISTINCT code_com, ', ') AS participants_code_com
      FROM
          defusion_com
      GROUP BY 
          nom_com_avant, code_com_avant
  ),
  com_apres AS (
      SELECT DISTINCT
          nom_com, code_com
      FROM 
          parc_", params$num_departement, "_", params$temps_apres,"
  )
  SELECT
      df.nom_com_avant,
      df.code_com_avant,
      CASE 
          WHEN c.nom_com IS NOT NULL THEN 
              'Défusion partielle'
          ELSE 
              'Défusion totale'
      END AS changement,
      df.participants,
      df.participants_code_com
  FROM
      defusion_data df
  LEFT JOIN 
      com_apres c ON c.nom_com = df.nom_com_avant
;"))

# Parcelles n'ayant pas été modifiées mise à part le nom de commune
```

```{r parcelle changeant de communes, eval=FALSE}
defusion_com <- st_read(conn, query = "SELECT * FROM defusion_com;")
```

## Cas des parcelles dans le cas d'une fusion de communes

```{r ajout/supp -> focus fusion commune}
dbExecute(conn, "TRUNCATE TABLE fusion_com;")

dbExecute(conn, "
  INSERT INTO fusion_com
  WITH apres AS (
      SELECT
          idu, nom_com, code_com, com_abs, contenance,
          SUBSTR(idu, 1, 2) || com_abs || '000' || SUBSTR(idu, 9, 14) AS idu_avant,
          geometry
      FROM
          ajout
      WHERE com_abs != '000'
  )
  SELECT 
      apres.idu, apres.nom_com, apres.code_com, apres.com_abs, apres.contenance,
         supp.idu, supp.nom_com, supp.code_com, apres.geometry
  FROM
      apres
  JOIN supp ON apres.idu_avant = supp.idu;
")

dbExecute(conn, paste0("
  INSERT INTO fusion_com
  WITH avant AS (
      SELECT
          idu, nom_com, code_com,
          SUBSTR(idu, 1, 2) AS prefix_idu,
          SUBSTR(idu, 6, 14) AS suffix_idu
      FROM
          supp
      WHERE com_abs != '000'
  )
  SELECT 
      ajout.idu, ajout.nom_com, ajout.code_com, ajout.com_abs, ajout.contenance,
         avant.idu, avant.nom_com, avant.code_com, ajout.geometry
  FROM
      avant
  JOIN ajout ON ajout.idu LIKE avant.prefix_idu || '___' || avant.suffix_idu
  WHERE avant.nom_com NOT IN (SELECT DISTINCT nom_com FROM parc_", params$num_departement, "_", params$temps_apres,") AND
  avant.nom_com IN (SELECT nom_com_avant FROM cas_disparition_commune GROUP BY nom_com_avant HAVING COUNT(nom_com) = 1);"))


dbExecute(conn, paste0(" 
  INSERT INTO chgt_commune
  WITH fusion_data AS (
      SELECT
          nom_com, 
          code_com, 
          STRING_AGG(DISTINCT nom_com_avant, ', ') AS participants,
          STRING_AGG(DISTINCT code_com_avant, ', ') AS participants_code_com
      FROM
          fusion_com
      GROUP BY 
          nom_com, code_com
  ),
  com_avant AS (
      SELECT DISTINCT
          nom_com, code_com
      FROM 
          parc_", params$num_departement, "_", params$temps_avant,"
  )
  SELECT
      f.nom_com,
      f.code_com,
      'Fusion' AS changement,
      CASE 
          WHEN c.nom_com IS NOT NULL THEN 
              STRING_AGG(DISTINCT c.nom_com || ', ' || f.participants, ', ')
          ELSE 
              f.participants 
      END AS participants,
      CASE 
          WHEN c.nom_com IS NOT NULL THEN 
              STRING_AGG(DISTINCT c.code_com || ', ' || f.participants_code_com , ', ')
          ELSE 
              f.participants_code_com 
      END AS participants_code_com
  FROM
      fusion_data f
  LEFT JOIN 
      com_avant c ON f.nom_com = c.nom_com
  GROUP BY
      f.nom_com, c.nom_com, f.code_com, f.participants, f.participants_code_com
;"))

dbExecute(conn, paste0(" 
  UPDATE chgt_commune
  SET 
      participants = cas_disparition_commune.nom_com_avant || ', ' || chgt_commune.participants,
      participants_code_com = cas_disparition_commune.code_com_avant || ', ' || chgt_commune.participants_code_com
  FROM cas_disparition_commune
  WHERE chgt_commune.nom_com = cas_disparition_commune.nom_com;
"))

dbExecute(conn, paste0(" 
  INSERT INTO chgt_commune
  SELECT nom_com, code_com, 'Changement de nom', nom_com_avant, code_com_avant
  FROM cas_disparition_commune
  WHERE nom_com NOT IN (SELECT nom_com FROM chgt_commune);
;"))


# Parcelles n'ayant pas été modifiées mise à part le nom de commune
```

```{r parcelle changeant de communes, eval=FALSE}
chgt_com <- dbGetQuery(conn, "SELECT * FROM chgt_commune;")
fusion_com <- st_read(conn, query = "SELECT * FROM fusion_com;")
```


# Focus parcelles avec changement "majeur" lié à un changement impactant l'identifiant des parcelles

## Elimination des parcelles IDENTIQUES en tout point du polygone (méthode de base pour enlever les cas reconnaissables facilement)

```{r ajout/supp geometry egal}
dbExecute(conn, "TRUNCATE TABLE ajout_simp, supp_simp;")

dbExecute(conn, "
  INSERT INTO ajout_simp
  SELECT idu, ST_SnapToGrid(geometry, 0.0001) AS geometry
  FROM ajout;
")

dbExecute(conn, "
  INSERT INTO supp_simp
  SELECT idu, ST_SnapToGrid(geometry, 0.0001) AS geometry
  FROM supp;
")

# Parcelles ajoutées n'ayant pas été modifiées
dbExecute(conn, "
  DELETE FROM ajout
  WHERE EXISTS (
      SELECT 1
      FROM ajout_simp
        JOIN supp_simp ON ST_Equals(ajout_simp.geometry, supp_simp.geometry)
      WHERE ajout.idu = ajout_simp.idu
       AND ST_IsValid(ajout_simp.geometry) and ST_IsValid(supp_simp.geometry)
);")

# Parcelles supprimées n'ayant pas été modifiées
dbExecute(conn, "
  DELETE FROM supp
  WHERE EXISTS (
      SELECT 1
      FROM supp_simp
        JOIN ajout_simp ON ST_Equals(ajout_simp.geometry, supp_simp.geometry)
      WHERE supp.idu = supp_simp.idu
       AND ST_IsValid(ajout_simp.geometry) and ST_IsValid(supp_simp.geometry)
);")
```

## Reconnaissances des cas de fusion (peu fréquent) ou subdivision (plus courant)

```{r ajout/supp iou -> fusion/subdivision}
dbExecute(conn, "TRUNCATE TABLE ajout_iou, supp_iou, fusion, subdiv;")

dbExecute(conn, "
  INSERT INTO supp_iou
  SELECT
      idu, nom_com, code_com, com_abs, contenance,
      (calcul_iou_intersec(geometry, 'ajout')).*,
      geometry
  FROM
      supp;
")

dbExecute(conn, "
  INSERT INTO subdiv
  SELECT *
  FROM supp_iou
  WHERE iou >= 0.99 AND LENGTH(participants) != 14;
")

dbExecute(conn, "
  DELETE FROM ajout
  WHERE idu IN 
      (SELECT unnest(regexp_split_to_array(participants, ',\\s*')) 
        FROM supp_iou WHERE iou >= 0.99);
")

dbExecute(conn, "
  DELETE FROM supp_iou
  WHERE iou >= 0.99;
")

dbExecute(conn, "
  INSERT INTO ajout_iou
  SELECT
      idu, nom_com, code_com, com_abs, contenance,
      (calcul_iou_intersec(geometry, 'supp_iou')).*,
      geometry
  FROM
      ajout;
")

dbExecute(conn, "
  INSERT INTO fusion
  SELECT *
  FROM ajout_iou
  WHERE iou >= 0.99 AND LENGTH(participants) != 14;
")

dbExecute(conn, "
  DELETE FROM supp_iou
  WHERE idu IN 
      (SELECT unnest(regexp_split_to_array(participants, ',\\s*')) 
        FROM ajout_iou WHERE iou >= 0.99);
")

dbExecute(conn, "
  DELETE FROM ajout_iou
  WHERE iou >= 0.99;
")
```

```{r fusion/subdivision, eval=FALSE}
supp <- st_read(conn, query = "SELECT * FROM supp_iou;")
subdiv <- st_read(conn, query = "SELECT * FROM subdiv;")
fusion <- st_read(conn, query = "SELECT * FROM fusion;")
```

## (Cas particulier du remaniement du PC d'une commune) Reconnaissances des cas de translation, modification de contour avec translation

```{r ajout/supp iou_ajust -> translation, contour + translation}
dbExecute(conn, "TRUNCATE TABLE ajout_iou_translate;")

dbExecute(conn, "
  INSERT INTO ajout_iou_translate
  SELECT DISTINCT
      idu, nom_com, code_com, com_abs, contenance, iou, participants,
      (calcul_iou_intersec_best_translate(geometry, 'supp_iou')).*,
      geometry
  FROM
      ajout_iou;
")

dbExecute(conn, "
  INSERT INTO translation
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_ajust, 
      idu_translate, geometry
  FROM ajout_iou_translate
  WHERE iou_ajust >= 0.99;
")

dbExecute(conn, "
  DELETE FROM ajout_iou_translate
  WHERE EXISTS (
      SELECT 1
      FROM translation
      WHERE ajout_iou_translate.idu = translation.idu
  );
")

dbExecute(conn, "
  DELETE FROM supp_iou
  WHERE EXISTS (
      SELECT 1
      FROM translation
      WHERE supp_iou.idu = translation.idu_translate
  );
")
```

```{r contour translation ou translation seule, eval=FALSE}
ajout <- st_read(conn, query = "SELECT * FROM ajout_iou_translate;")
translation <- st_read(conn, query = "SELECT * FROM translation;")
contour_translation <- st_read(conn, query = "SELECT * FROM contour_translation;")
```

## Reconnaissances des cas de multi-subdivision (ex : 2 -> 3) ou modification de contours

```{r ajout/supp iou_multi -> multi-subdivision et contours}
dbExecute(conn, "TRUNCATE TABLE multi_calcul_cache, supp_iou_multi, 
          redecoupage, contour_transfo;")

dbExecute(conn, "
  INSERT INTO supp_iou_multi
  SELECT
      idu, nom_com, code_com, com_abs, contenance, iou, participants, 
      (calcul_iou_multi(idu, geometry, 'supp_iou', 'ajout_iou_translate')).*,
      geometry
  FROM
      supp_iou;
")

dbExecute(conn, "
  INSERT INTO redecoupage
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_multi, 
      participants_avant, participants_apres, geometry
  FROM supp_iou_multi
  WHERE iou_multi >= 0.99 AND LENGTH(participants_apres) != LENGTH(participants_avant);
")

dbExecute(conn, "
  INSERT INTO contour
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_multi, 
      participants_avant, participants_apres, geometry
  FROM supp_iou_multi
  WHERE iou_multi >= 0.95 AND LENGTH(participants_apres) = LENGTH(participants_avant);
")

dbExecute(conn, "
  INSERT INTO contour_transfo
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_multi, 
      participants_avant, participants_apres, geometry
  FROM supp_iou_multi
  WHERE (iou_multi >= 0.95 AND LENGTH(participants_apres) != LENGTH(participants_avant)
   AND iou_multi < 0.99);
")


dbExecute(conn, "
  DELETE FROM ajout_iou_translate
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_apres, ',\\s*')) FROM redecoupage)
    OR idu IN (SELECT unnest(regexp_split_to_array(participants_apres, ',\\s*')) FROM contour)
    OR idu IN (SELECT unnest(regexp_split_to_array(participants_apres, ',\\s*')) FROM contour_transfo);
")

dbExecute(conn, "
  DELETE FROM supp_iou_multi
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) FROM redecoupage)
    OR idu IN (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) FROM contour)
    OR idu IN (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) FROM contour_transfo);
")
```

```{r multisubdiv sql, eval=FALSE}
supp <- st_read(conn, query = "SELECT * FROM supp_iou_multi;")
redecoupage <- st_read(conn, query = "SELECT * FROM redecoupage;")
contour_transfo <- st_read(conn, query = "SELECT * FROM contour_transfo;")
contour <- st_read(conn, query = "SELECT * FROM contour;")
```

## Reconnaissances des cas de modification de contours plus compliquée

## Cas rapide translation transformation

```{r rapide}
dbExecute(conn, "TRUNCATE TABLE supp_iou_multi_translate_rapide, max_iou, 
          multi_translate_rapide, contour_transfo_translation;")

dbExecute(conn, "
  INSERT INTO supp_iou_multi_translate_rapide
  SELECT 
      idu, nom_com, code_com, com_abs, contenance, iou, participants,
      iou_multi, participants_avant, participants_apres,
      (calcul_iou_multi_translate_rapide(geometry, 'supp_iou_multi', 'ajout_iou_translate')).*,
      geometry
  FROM
      supp_iou_multi;
")

dbExecute(conn, "
  INSERT INTO max_iou
  SELECT idu, MAX(iou_multi_translate) AS max_iou
  FROM (
      SELECT unnest(regexp_split_to_array(participants_avant_translate, ',\\s*')) AS idu, iou_multi_translate
      FROM supp_iou_multi_translate_rapide
      WHERE iou_multi_translate >= 0.95
  ) subquery
  GROUP BY idu;
")

dbExecute(conn, "
  INSERT INTO multi_translate_rapide
  SELECT DISTINCT ON (sub.idu) sub.idu, sub.iou_multi_translate, 
      sub.participants_avant_translate, sub.participants_apres_translate
  FROM (
      SELECT unnest(regexp_split_to_array(participants_avant_translate, ',\\s*')) AS idu, 
          iou_multi_translate, participants_avant_translate, participants_apres_translate
      FROM supp_iou_multi_translate_rapide
      WHERE iou_multi_translate >= 0.95
  ) sub
  JOIN max_iou mi
  ON sub.idu = mi.idu AND sub.iou_multi_translate = mi.max_iou
  ORDER BY sub.idu, sub.iou_multi_translate DESC;
")

dbExecute(conn, "
  INSERT INTO contour_transfo_translation
  SELECT simtr.idu, simtr.nom_com, simtr.code_com, simtr.com_abs, 
      simtr.contenance, mtr.iou_multi_translate, 
      mtr.participants_avant_translate, mtr.participants_apres_translate, 
      simtr.geometry
  FROM multi_translate_rapide mtr
  LEFT JOIN supp_iou_multi_translate_rapide simtr ON mtr.idu = simtr.idu;
")

dbExecute(conn, "
  DELETE FROM ajout_iou_translate
  WHERE idu IN 
      (SELECT unnest(regexp_split_to_array(participants_apres_translate, ',\\s*')) 
        FROM multi_translate_rapide);
")

dbExecute(conn, "
  DELETE FROM supp_iou_multi_translate_rapide
  WHERE idu IN 
      (SELECT unnest(regexp_split_to_array(participants_avant_translate, ',\\s*')) 
        FROM multi_translate_rapide);
")
```

```{r contour_transfo_translation_rapide, eval=FALSE}
contour_transfo_translation <- st_read(conn, query = "SELECT * FROM contour_transfo_translation;")
```

```{r}
dbExecute(conn, "
  WITH updated_values AS (
    SELECT idu,
           (calcul_iou_intersec_best_translate(geometry, 'supp_iou_multi_translate_rapide')).*
    FROM ajout_iou_translate
  )
  UPDATE ajout_iou_translate
  SET iou_ajust = updated_values.iou_ajust,
      idu_translate = updated_values.idu_translate
  FROM updated_values
  WHERE ajout_iou_translate.idu = updated_values.idu
")

dbExecute(conn, "
  INSERT INTO contour_translation
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_ajust, 
      idu_translate, geometry
  FROM ajout_iou_translate
  WHERE (iou < 0.95 AND iou_ajust >= 0.95 AND iou_ajust < 0.99);
")

dbExecute(conn, "
  DELETE FROM ajout_iou_translate
  WHERE EXISTS (
      SELECT 1
      FROM translation
      WHERE ajout_iou_translate.idu = translation.idu
  ) OR EXISTS (
      SELECT 1
      FROM contour_translation
      WHERE ajout_iou_translate.idu = contour_translation.idu
  );
")

dbExecute(conn, "
  DELETE FROM supp_iou_multi_translate_rapide
  WHERE EXISTS (
      SELECT 1
      FROM translation
      WHERE supp_iou_multi_translate_rapide.idu = translation.idu_translate
  ) OR EXISTS (
      SELECT 1
      FROM contour_translation
      WHERE supp_iou_multi_translate_rapide.idu = contour_translation.idu_translate
  );
")

```


## (Cas particulier du remaniement du PC d'une commune) Reconnaissances des cas de translation avec modification de contour et avec fusion

```{r ajout/supp iou_ajust -> contour_fusion_translation}
dbExecute(conn, "TRUNCATE TABLE multi_calcul_cache, supp_iou_multi_translate;")

dbExecute(conn, "
  INSERT INTO supp_iou_multi_translate
  SELECT 
      idu, nom_com, code_com, com_abs, contenance, iou, participants,
      iou_multi, participants_avant, participants_apres,
      (calcul_iou_multi_translate(idu, geometry, 'supp_iou_multi_translate_rapide', 'ajout_iou_translate')).*,
      geometry
  FROM
      supp_iou_multi_translate_rapide;
")

#Probleme maintenant
dbExecute(conn, "
  INSERT INTO contour_transfo_translation
  SELECT idu, nom_com, code_com, com_abs, contenance, iou_multi_translate, 
      participants_avant_translate, participants_apres_translate, geometry
  FROM supp_iou_multi_translate
  WHERE iou_multi_translate >= 0.95;
")

dbExecute(conn, "
  DELETE FROM ajout_iou_translate
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_apres_translate, ',\\s*')) FROM contour_transfo_translation);
")

dbExecute(conn, "
  DELETE FROM supp_iou_multi_translate
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_avant_translate, ',\\s*')) FROM contour_transfo_translation);
")
```

```{r contour_fusion_translation, eval=FALSE}
contour_transfo_translation <- st_read(conn, query = "SELECT * FROM contour_transfo_translation;")
```

# Ajout d'un iou_multi pour ajout

```{r}
dbExecute(conn, "TRUNCATE TABLE multi_calcul_cache, multi_ajout;")

dbExecute(conn, "
  INSERT INTO multi_ajout
  WITH calc_results AS (
      SELECT
          idu,
          (calcul_iou_multi(idu, geometry, 'ajout_iou_translate', 'supp_iou_multi_translate')).*
      FROM
          ajout_iou_translate
  )
  SELECT DISTINCT
      unnest(string_to_array(participants_apres, ', ')) AS idu, 
      iou_multi,
      participants_apres,
      participants_avant
  FROM
      calc_results
  WHERE iou_multi >= 0.95;
")

dbExecute(conn, "
  INSERT INTO redecoupage
  SELECT simt.idu, simt.nom_com, simt.code_com, simt.com_abs, simt.contenance, 
      ma.iou_multi, ma.participants_avant, ma.participants_apres, simt.geometry
  FROM supp_iou_multi_translate simt
  LEFT JOIN multi_ajout ma ON ma.idu = simt.idu
  WHERE ma.iou_multi >= 0.99 AND LENGTH(ma.participants_apres) != LENGTH(ma.participants_avant);
")

dbExecute(conn, "
  INSERT INTO contour
  SELECT simt.idu, simt.nom_com, simt.code_com, simt.com_abs, simt.contenance, 
      ma.iou_multi, ma.participants_avant, ma.participants_apres, simt.geometry
  FROM supp_iou_multi_translate simt
  LEFT JOIN multi_ajout ma ON ma.idu = simt.idu
  WHERE ma.iou_multi >= 0.95 AND LENGTH(ma.participants_apres) = LENGTH(ma.participants_avant);
")

dbExecute(conn, "
  INSERT INTO contour_transfo
  SELECT simt.idu, simt.nom_com, simt.code_com, simt.com_abs, simt.contenance, 
      ma.iou_multi, ma.participants_avant, ma.participants_apres, simt.geometry
  FROM supp_iou_multi_translate simt
  LEFT JOIN multi_ajout ma ON ma.idu = simt.idu
  WHERE (ma.iou_multi >= 0.95 AND LENGTH(ma.participants_apres) != LENGTH(ma.participants_avant)
   AND ma.iou_multi < 0.99);
")


dbExecute(conn, "
  DELETE FROM ajout_iou_translate
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_apres, ',\\s*')) FROM redecoupage)
    OR idu IN (SELECT unnest(regexp_split_to_array(participants_apres, ',\\s*')) FROM contour)
    OR idu IN (SELECT unnest(regexp_split_to_array(participants_apres, ',\\s*')) FROM contour_transfo);
")

dbExecute(conn, "
  DELETE FROM supp_iou_multi_translate
  WHERE idu IN (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) FROM redecoupage)
    OR idu IN (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) FROM contour)
    OR idu IN (SELECT unnest(regexp_split_to_array(participants_avant, ',\\s*')) FROM contour_transfo);
")
```


## Recalcul de l'IoU pour détecter les parcelles maintenant isolées -> Véritable ajout ou suppression

```{r le reste}
dbExecute(conn, "TRUNCATE TABLE vrai_ajout, vrai_supp;")

dbExecute(conn, "
  WITH updated_values AS (
    SELECT idu,
           (calcul_iou_intersec(geometry, 'ajout_iou_translate')).*
    FROM supp_iou_multi_translate
  )
  UPDATE supp_iou_multi_translate
  SET iou = updated_values.iou,
      participants = updated_values.participants
  FROM updated_values
  WHERE supp_iou_multi_translate.idu = updated_values.idu
")

dbExecute(conn, "
  WITH updated_values AS (
    SELECT idu,
           (calcul_iou_intersec(geometry, 'supp_iou_multi_translate')).*
    FROM ajout_iou_translate
  )
  UPDATE ajout_iou_translate
  SET iou = updated_values.iou,
      participants = updated_values.participants
  FROM updated_values
  WHERE ajout_iou_translate.idu = updated_values.idu
")

dbExecute(conn, "
  INSERT INTO vrai_ajout
  SELECT idu, nom_com, code_com, com_abs, contenance, iou, participants, geometry
  FROM ajout_iou_translate
  WHERE iou IS NULL;
")

dbExecute(conn, "
  INSERT INTO vrai_supp
  SELECT idu, nom_com, code_com, com_abs, contenance, iou, participants, geometry
  FROM supp_iou_multi_translate
  WHERE iou IS NULL;
")

dbExecute(conn, "
  DELETE FROM ajout_iou_translate
  WHERE EXISTS (
      SELECT 1
      FROM vrai_ajout
      WHERE ajout_iou_translate.idu = vrai_ajout.idu
  );
")

dbExecute(conn, "
  DELETE FROM supp_iou_multi_translate
  WHERE EXISTS (
      SELECT 1
      FROM vrai_supp
      WHERE supp_iou_multi_translate.idu = vrai_supp.idu
  );
")
```


```{r le reste, eval=FALSE}
ajout <- st_read(conn, query = "SELECT * FROM ajout_iou_translate;")
supp <- st_read(conn, query = "SELECT * FROM supp_iou_multi_translate;")

vrai_ajout <- st_read(conn, query = "SELECT * FROM vrai_ajout;")
vrai_supp <- st_read(conn, query = "SELECT * FROM vrai_supp;")

# 132078330A0082 cas d'une parcelle disparu en 2024 mais pas affiché comme vrai supp -> multipolygon empty
# 13041000AM0018 parcelle participant a une multi subdiv mais qui a l'air iou parfait
```


```{r carte reste, eval=FALSE}
ajout <- st_read(conn, query = "SELECT * FROM ajout_iou_translate;")
supp <- st_read(conn, query = "SELECT * FROM supp_iou_multi_translate;")
modif_avant <- st_read(conn, query = "SELECT * FROM modif_avant_iou_multi;")
modif_apres <- st_read(conn, query = "SELECT * FROM modif_apres_iou;")

map <- mapview()

if (nrow(ajout) > 0) {
  map <- map + mapview(ajout,
                       z = c("iou_ajust"), layer.name = paste0("Parcelles restantes (état 20",params$temps_apres,")"), 
                       alpha.regions = 0.5, homebutton = F)
}
if (nrow(supp) > 0) {
  map <- map + mapview(supp, 
                       z = c("iou_multi"), layer.name = paste0("Parcelles restantes (état 20",params$temps_avant,")"), 
                       alpha.regions = 0.5, homebutton = F)
}
if (nrow(modif_apres) > 0) {
  map <- map + mapview(modif_apres, 
                       z = c("iou_ajust"), 
                       layer.name = paste0("Parcelles modifiées restantes (état 20",params$temps_apres,")"), 
                       alpha.regions = 0.5, homebutton = F)
  
}
if (nrow(modif_avant) > 0) {
  map <- map + mapview(modif_avant, 
                       z = c("iou_ajust"), 
                       layer.name = paste0("Parcelles modifiées restantes (état 20",params$temps_avant,")"), 
                       alpha.regions = 0.5, homebutton = F)
}
mapshot(map, url = paste0("parcelles_restantes_",params$num_departement,"_",params$temps_apres,"-",params$temps_avant,".html"))
```


```{r nettoyage table inutile}
dbExecute(conn, "
  DROP TABLE IF EXISTS multi_calcul_cache, identique, ajout, supp, 
  modif_avant, modif_apres, modif, modif_avant_iou, supp_iou, ajout_iou, 
  supp_iou_multi, ajout_simp, supp_simp,
  supp_iou_multi_translate_rapide, max_iou, cas_disparition_commune,
  multi_translate_rapide, multi_ajout CASCADE
;")
dbListTables(conn)
```

# Visualisation finale sur une carte du département

```{r mapview typologie parcelles, eval=FALSE}
bordure <- st_read(conn, query = "SELECT * FROM bordure;")

parc_avant <- st_read(conn, query = paste0("SELECT * FROM parc_", params$num_departement, "_", params$temps_avant, ";"))
parc_apres <- st_read(conn, query = paste0("SELECT * FROM parc_", params$num_departement, "_", params$temps_apres, ";"))

contour <- st_read(conn, query = "SELECT * FROM contour;")
translation <- st_read(conn, query = "SELECT * FROM translation;")
contour_translation <- st_read(conn, query = "SELECT * FROM contour_translation;")
contour_transfo_translation <- st_read(conn, query = "SELECT * FROM contour_transfo_translation;")
redecoupage <- st_read(conn, query = "SELECT * FROM redecoupage;")
contour_transfo <- st_read(conn, query = "SELECT * FROM contour_transfo;")
defusion_com <- st_read(conn, query = "SELECT * FROM defusion_com;")
fusion_com <- st_read(conn, query = "SELECT * FROM fusion_com;")
subdiv <- st_read(conn, query = "SELECT * FROM subdiv;")
fusion <- st_read(conn, query = "SELECT * FROM fusion;")
vrai_ajout <- st_read(conn, query = "SELECT * FROM vrai_ajout;")
vrai_supp <- st_read(conn, query = "SELECT * FROM vrai_supp;")

ajout <- st_read(conn, query = "SELECT * FROM ajout_iou_translate;")
supp <- st_read(conn, query = "SELECT * FROM supp_iou_multi_translate;")
modif_avant <- st_read(conn, query = "SELECT * FROM modif_avant_iou_multi;")
modif_apres <- st_read(conn, query = "SELECT * FROM modif_apres_iou;")

map <- mapview(bordure, 
               layer.name = "Bordures étendues", col.regions = "#F2F2F2", 
               alpha.regions = 0.7, homebutton = F,
               map.types = c("CartoDB.Positron", "OpenStreetMap", "Esri.WorldImagery"))

if (nrow(translation) > 0) {
  map <- map + mapview(translation,
                       layer.name = paste0("Parcelles translatées (état 20",params$temps_apres,")"), 
                       col.regions = "#069F9C",
                       alpha.regions = 0.5, homebutton = F) +
    mapview(parc_avant %>%
              filter(idu %in% translation$idu_translate),
            col.regions = "#069F9C",
            layer.name = paste0("Parcelles translatées (état 20",params$temps_avant,")"), 
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(fusion) > 0) {
  map <- map + mapview(fusion, 
                       layer.name = paste0("Parcelles fusionnéees (état 20",params$temps_apres,")"),
                       col.regions = "#5F1972", alpha.regions = 0.5, homebutton = F) +
    mapview(parc_avant %>%
              filter(idu %in% unlist(str_split(fusion$participants, ",\\s*"))),  
            layer.name = paste0("Parcelles fusionnéees (état 20",params$temps_avant,")"), 
            col.regions = "#5F1972",
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(subdiv) > 0) {
  map <- map + mapview(parc_apres %>%
                         filter(idu %in% unlist(str_split(subdiv$participants, ",\\s*"))),  
                       layer.name = paste0("Parcelles subdivisées (état 20",params$temps_apres,")"), 
                       col.regions = "#AE48C0",
                       alpha.regions = 0.5, homebutton = F) +
    mapview(subdiv,  
            layer.name = paste0("Parcelles subdivisées (état 20",params$temps_avant,")"), 
            col.regions = "#AE48C0", alpha.regions = 0.5, homebutton = F)
}
if (nrow(redecoupage) > 0) {
  map <- map + mapview(parc_apres %>%
                         filter(idu %in% unlist(str_split(redecoupage$participants_apres, ",\\s*"))),
                       layer.name = paste0("Parcelles redécoupage (état 20",params$temps_apres,")"),
                       col.regions = "#E0BDE6",
                       alpha.regions = 0.5, homebutton = F) +
    mapview(redecoupage,  
            layer.name = paste0("Parcelles redécoupage (état 20",params$temps_avant,")"), 
            col.regions = "#E0BDE6", alpha.regions = 0.5, homebutton = F)
  
}
if (nrow(contour) > 0) {
  map <- map + mapview(parc_apres %>%
                         filter(idu %in% unlist(str_split(contour$participants_apres, ",\\s*"))),  
                       layer.name = paste0("Parcelles contours (état 20",params$temps_apres,")"), 
                       col.regions = "#D79700", alpha.regions = 0.5, homebutton = F)  +
    mapview(contour,  
            layer.name = paste0("Parcelles contours (état 20",params$temps_avant,")"),
            col.regions = "#D79700",
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(contour_transfo) > 0) {
  map <- map + mapview(parc_apres %>%
                         filter(idu %in% unlist(str_split(contour_transfo$participants_apres, ",\\s*"))),  
                       layer.name = paste0("Parcelles transfo + contours (état 20",params$temps_apres,")"),
                       col.regions = "#FFB9BB",
                       alpha.regions = 0.5, homebutton = F) +
    mapview(contour_transfo,
            layer.name = paste0("Parcelles transfo + contours (état 20",params$temps_avant,")"), 
            col.regions = "#FFB9BB", alpha.regions = 0.5, homebutton = F)
}
if (nrow(contour_translation) > 0) {
  map <- map + mapview(contour_translation,  
                       layer.name = paste0("Parcelles translatées + contours (état 20",params$temps_apres,")"), 
                       alpha.regions = 0.5, homebutton = F) +
    mapview(parc_avant %>%
              filter(idu %in% contour_translation$idu_translate),
            layer.name = paste0("Parcelles translatées + contours (état 20",params$temps_avant,")"), 
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(contour_transfo_translation) > 0) {
  map <- map + mapview(parc_apres %>%
                         filter(idu %in% unlist(str_split(contour_transfo_translation$participants_apres_translate, ",\\s*"))),
                       layer.name = paste0("Parcelles transfo + translatées + contours (état 20",params$temps_apres,")"), 
                       col.regions = "#B5E1FF", alpha.regions = 0.5, homebutton = F) +
    mapview(contour_transfo_translation,  
            layer.name = paste0("Parcelles transfo + translatées + contours (état 20",params$temps_avant,")"), 
            col.regions = "#B5E1FF",
            alpha.regions = 0.5, homebutton = F)
}
if (nrow(defusion_com) > 0) {
  map <- map + mapview(defusion_com,  
                       layer.name = paste0("Parcelles défusion de communes (état 20",params$temps_apres,")"), 
                       col.regions = "white",
                       alpha.regions = 0.5, homebutton = F) +
    mapview(parc_avant %>%
              filter(idu %in% defusion_com$idu_avant),  
            layer.name = paste0("Parcelles défusion de communes (état 20",params$temps_avant,")"), 
            col.regions = "white", alpha.regions = 0.5, homebutton = F)
}
if (nrow(fusion_com) > 0) {
  map <- map + mapview(fusion_com,  
                       layer.name = paste0("Parcelles fusion de communes (état 20",params$temps_apres,")"), 
                       col.regions = "white",
                       alpha.regions = 0.5, homebutton = F) +
    mapview(parc_avant %>%
              filter(idu %in% fusion_com$idu_avant),  
            layer.name = paste0("Parcelles fusion de communes (état 20",params$temps_avant,")"), 
            col.regions = "white", alpha.regions = 0.5, homebutton = F)
}
if (nrow(vrai_ajout) > 0) {
  map <- map + mapview(vrai_ajout, 
                       layer.name = "Parcelles véritablement ajoutées", 
                       col.regions = "#26A44B", alpha.regions = 0.5, homebutton = F)
  
}
if (nrow(vrai_supp) > 0) {
  map <- map + mapview(vrai_supp,
                       layer.name = "Parcelles véritablement supprimées",
                       col.regions = "#E91422", alpha.regions = 0.5, homebutton = F) 
}
if (nrow(ajout) > 0) {
  map <- map + mapview(ajout,
                       z = c("iou_ajust"), layer.name = paste0("Parcelles restantes (état 20",params$temps_apres,")"), 
                       alpha.regions = 0.5, homebutton = F)
}
if (nrow(supp) > 0) {
  map <- map + mapview(supp, 
                       z = c("iou_multi"), layer.name = paste0("Parcelles restantes (état 20",params$temps_avant,")"), 
                       alpha.regions = 0.5, homebutton = F)
}
if (nrow(modif_apres) > 0) {
  map <- map + mapview(modif_apres, 
                       z = c("iou_ajust"), 
                       layer.name = paste0("Parcelles modifiées restantes (état 20",params$temps_apres,")"), 
                       alpha.regions = 0.5, homebutton = F)
  
}
if (nrow(modif_avant) > 0) {
  map <- map + mapview(modif_avant, 
                       z = c("iou_ajust"), 
                       layer.name = paste0("Parcelles modifiées restantes (état 20",params$temps_avant,")"), 
                       alpha.regions = 0.5, homebutton = F)
}
mapshot(map, url = paste0("parcelles_",params$num_departement,"_",params$temps_apres,"-",params$temps_avant,".html"))
```
